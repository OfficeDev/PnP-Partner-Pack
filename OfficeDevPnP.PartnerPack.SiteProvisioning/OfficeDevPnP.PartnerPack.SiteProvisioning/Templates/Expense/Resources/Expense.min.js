$(document).ready(function(){var e;e={expenseItemDialog:"",EXPENSE_LIST_NAME:"Expense",EXPENSEITEMS_LIST_NAME:"ExpenseItems",EXPENSE_FINANCE_MANAGERWORKFLOW_LIST_NAME:"FinanceManagerWorkflow",SiteURL:window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl+"/",myExpenses:[],CheckExpenseListValidation:function(){var e,t,a,n;return e=$("#bill_type").val(),t=$("#bill_no").val(),a=$("#bill_date").val(),n=$("#bill_amount_rupees").val(),0==jQuery.trim(e).length||0==jQuery.trim(t).length||0==jQuery.trim(a).length||0==jQuery.trim(n).length?!1:!0},CheckFormDataValidation:function(){var e,t,a,n,o,i,l;return e=$("#user_name_bank_account").val(),t=$("#emp_code").val(),a=$("#bank_account_number").val(),n=$("#client_name").val(),o=$("#project").val(),i=$("#dept").val(),l=$("#claim_subject").val(),0==jQuery.trim(e).length||0==jQuery.trim(t).length||0==jQuery.trim(o).length||0==jQuery.trim(i).length||0==jQuery.trim(a).length||0==jQuery.trim(n).length||$(".cam-entity-resolved").text().length<=0||0==jQuery.trim(l).length?!1:!0},AddExpense:function(){var t,a,n,o,i,l,r;t=$("#users tbody").children().length+1,a=$("#bill_type"),n=$("#bill_no"),o=$("#bill_date"),i=$("#vendor_name"),l=$("#bill_particulars"),r=$("#bill_amount_rupees");var s=e.CheckExpenseListValidation();s?($("#div_error").hide(),$("#users tbody").append("<tr><td>"+t+"</td><td>"+a.val()+"</td><td>"+n.val()+"</td><td>"+o.val()+"</td><td>"+i.val()+"</td><td>"+l.val()+"</td><td>"+r.val()+"</td></tr>"),e.expenseItemDialog.dialog("close")):$("#div_error").show()},GenerateExpenseReportId:function(){var e=Math.floor(9e5*Math.random())+1e5;return e},GetItemTypeForListName:function(e){return"SP.Data."+e.charAt(0).toUpperCase()+e.split(" ").join("").slice(1)+"ListItem"},GetEmailFromText:function(e){var t=e.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);return null!=t&&t.length>0?t[0]:""},EnsureUser:function(e){var t=0;return $.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/ensureUser('"+encodeURIComponent(e)+"')",type:"POST",async:!1,contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(e){e.d.Id>0&&(t=e.d.Id)},error:function(e){console.log(JSON.stringify(e))}}),t},SaveNewExpenseInfo:function(){var t=$("#claim_subject").val(),a=$("#emp_code").val(),n=$("#user_name_bank_account").val(),o=$("#bank_account_number").val(),i=$("#bill_to_client").val(),l=$("#dept").val(),r=$("#project").val(),s=$("#client_name").val(),c=e.GenerateExpenseReportId(),p=e.GetTableData(),u=p.sum("amount"),m=e.GetItemTypeForListName(e.EXPENSE_LIST_NAME),d=(_spPageContextInfo.userId,e.GetEmailFromText($("#hdnAdministrators").val().split(",")[2])),g="i:0#.f|membership|"+d,f={__metadata:{type:m},Title:t,ClaimNumber:String(c),EmployeeNumber:a,EmployeeName:n,BankAccountNumber:o,ReimburseFromClient:i,Department:l,Project:r,ClientName:s,ClaimStatus:"New",ClaimAmount:u,ApproverId:e.EnsureUser(g)};$.ajax({url:e.SiteURL+"_api/web/lists/getbytitle('"+e.EXPENSE_LIST_NAME+"')/items",type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(f),async:!1,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(t){$("#spanStatus").html("Expense report created successfully").removeClass("ticketerror").addClass("ticketsuccess"),$(".cam-peoplepicker-delImage").click(),e.UploadFile(f.ClaimNumber,e.EXPENSE_LIST_NAME,e.SiteURL,"attachments"),e.SaveNewExpenseItemInfo(p,f.ClaimNumber),console.log("Expense report created successfully")},error:function(e){$("#spanStatus").html("Expense report creation failed").removeClass("ticketsuccess").addClass("ticketerror"),$(".cam-peoplepicker-delImage").click(),console.log("Expense report creation failed")}})},SaveNewExpenseItemInfo:function(t,a){var n=e.GetItemTypeForListName(e.EXPENSEITEMS_LIST_NAME);for(expenseitemcounter=0;expenseitemcounter<t.length;expenseitemcounter++){var o={__metadata:{type:n},ClaimNumber:a,BillNumber:t[expenseitemcounter].billnumber,BillDate:t[expenseitemcounter].billdate,BillTypeId:t[expenseitemcounter].billtype,VendorName:t[expenseitemcounter].vendorname,BillDescription:t[expenseitemcounter].billdescription,BillAmount:t[expenseitemcounter].amount};$.ajax({url:e.SiteURL+"_api/web/lists/getbytitle('"+e.EXPENSEITEMS_LIST_NAME+"')/items",type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(o),async:!1,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(e){console.log("ExpenseItem created successfully")},error:function(e){console.log("ExpenseItem creation failed")}})}},GetTableData:function(){var e=[],t=0;return $("#users tbody tr").each(function(a,n){var o=$(n).find("td");o.length>1&&(e[t++]={sno:o[0].textContent,billtype:parseInt(o[1].textContent),billnumber:o[2].textContent,billdate:o[3].textContent,vendorname:o[4].textContent,billdescription:o[5].textContent,amount:parseFloat(o[6].textContent)})}),e},DisplayMyExpenses:function(e){e.length>0?$("#Refresh-tickets").prop("disabled",!1):$("#Refresh-tickets").prop("disabled",!0),$("#tblMyExpenses").DataTable({destroy:!0,lengthMenu:[5,10],data:e,columns:[{title:"Claim Number#"},{title:"Claim Description"},{title:"Claim Date"},{title:"Total Amount"},{title:"Claim Status"},{title:"",render:function(e,t){return"display"===t&&""!==e?$("<a>").attr("href","#").attr("id",e).text("Display").wrap("<div></div>").parent().html():"Display"}}]})},GetAllExpenses:function(){e.myExpenses=[],$.ajax({url:e.SiteURL+"_api/lists/getbytitle('"+e.EXPENSE_LIST_NAME+"')/items?$select=Title,ClaimNumber,Created,ClaimStatus,ClaimAmount&$filter=AuthorId eq "+_spPageContextInfo.userId,method:"GET",headers:{accept:"application/json;odata=verbose"},success:function(t){var a=t.d.results;$.each(a,function(t){var n=a[t],o=[];o.push(n.ClaimNumber),o.push(n.Title),o.push(new Date(n.Created).toLocaleDateString()),o.push(n.ClaimAmount),o.push(n.ClaimStatus),"New"!==n.ClaimStatus?o.push(n.ClaimNumber):o.push(""),e.myExpenses.push(o)}),e.DisplayMyExpenses(e.myExpenses)},error:function(e){$("#tblMyExpenses tbody").html("<h3>An error occured</h3><br/>"+JSON.stringify(e))}})},ExpenseDialogReset:function(){$("#bill_type").val(2),$("#bill_no").val(""),$("#bill_date").val(""),$("#vendor_name").val(""),$("#bill_particulars").val(""),$("#bill_amount_rupees").val("")},GetFinanceManagerWorkFlowDetails:function(){var t=e.SiteURL+"/_api/web/lists/getbytitle('"+e.EXPENSE_FINANCE_MANAGERWORKFLOW_LIST_NAME+"')/ItemCount";$.ajax({url:t,method:"GET",async:!1,headers:{Accept:"application/json; odata=verbose"},success:function(e){e.d.ItemCount>=1?($("#finaceManagerWorkFlow").hide(),$("#submit-expense").prop("disabled",!1)):($("#finaceManagerWorkFlow").show(),$("#submit-expense").prop("disabled",!0))},error:function(e){console.log("Error while retrieving information from FinanceManagerWorkflow")}})},SaveFinanceManagerWorkflowDetails:function(){var t=e.GetItemTypeForListName(e.EXPENSE_FINANCE_MANAGERWORKFLOW_LIST_NAME),a=e.GetEmailFromText($("#hdnAdministrators1").val().split(",")[2]),n="i:0#.f|membership|"+a,o={__metadata:{type:t},FinanceManagerId:e.EnsureUser(n)};$.ajax({url:e.SiteURL+"_api/web/lists/getbytitle('"+e.EXPENSE_FINANCE_MANAGERWORKFLOW_LIST_NAME+"')/items",type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(o),headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(e){$("#spanStatus").html("Finance Manager Workflow record created successfully").addClass("ticketsuccess"),$("#submit-expense").prop("disabled",!1),console.log("Finance Manager Workflow record created successfully")},error:function(e){$("#spanStatus").html("Finance Manager Workflow record creation failed").addClass("ticketerror"),console.log("Finance Manager Workflow record creation failed")}})},BindDropDownByIdListName:function(t,a){$.ajax({url:e.SiteURL+"_api/web/lists/getbytitle('"+a+"')/items",type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(e){var a=e.d.results;$.each(a,function(e){var n=a[e];$("#"+t).append($("<option></option>").val(n.ID).html(n.Title))}),$("#bill_type").val(2)},error:function(e){console.log(e),console.log("Operataion failed")}})},FormReset:function(){return $("#emp_code").val(""),$("#user_name_bank_account").val(""),$("#bank_account_number").val(""),$("#bill_to_client").val("false"),$("#dept").val(""),$("#project").val(""),$("#client_name").val(""),$("#attachments").val(""),$(".cam-peoplepicker-delImage").click(),$("#claim_subject").val(""),$("#users").find("tbody tr").remove(),e.ExpenseDialogReset(),!1},GetExpenseByClaimNumber:function(t){var a,n=e.SiteURL+"_api/lists/getbytitle('"+e.EXPENSE_LIST_NAME+"')/items?$select=ID&$filter=ClaimNumber eq "+t;return $.ajax({url:n,async:!1,method:"GET",headers:{accept:"application/json;odata=verbose"},success:function(e){a=e.d.results[0]},error:function(e){console.log("Error occurred while retrieving the ticket")}}),a},WriteFileToList:function(e,t,a,n,o){var i=new FileReader;i.onload=function(i){if(null!=e&&e.name.length>0){var l=a+"_api/web/lists/getByTitle(@TargetLibrary)/Items("+n+")/AttachmentFiles/add(FileName=@TargetFileName)?@TargetLibrary='"+o+"'&@TargetFileName='"+e.name+"'",r=i.target.result;$.ajax({url:l,async:!1,type:"POST",data:r,processData:!1,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":t},success:function(e){console.log("File uploaded successfully")},error:function(e){console.log("File upload failed. Please try again")}})}},i.readAsArrayBuffer(e)},UploadFile:function(t,a,n,o){var i=e.GetDigest(),l=e.GetExpenseByClaimNumber(t),r=l.ID,s=$("#"+o)[0].files.length;if(s>0)for(fileindex=0;fileindex<s;fileindex++){var c=$("#"+o)[0].files[fileindex];e.WriteFileToList(c,i,n,r,a)}},GetExpenseByID:function(t){var a="",n=e.SiteURL+"_api/lists/getbytitle('"+e.EXPENSE_LIST_NAME+"')/items?$select=ManagerComments,FinanceManagerComments&$filter=ClaimNumber eq "+t;return $.ajax({url:n,async:!1,method:"GET",headers:{accept:"application/json;odata=verbose"},success:function(e){a=e.d.results[0]},error:function(e){console.log("Error occurred while retrieving the Expense details")}}),a},GetDigest:function(){var e;return $.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/contextinfo",method:"POST",async:!1,headers:{Accept:"application/json; odata=verbose"},success:function(t){e=t.d.GetContextWebInformation.FormDigestValue},error:function(e,t,a){alert(a)}}),e}},$("#bill_date").datepicker({maxDate:"0"}),e.BindDropDownByIdListName("bill_type","BillType"),e.GetFinanceManagerWorkFlowDetails(),e.GetAllExpenses(),e.expenseItemDialog=$("#dialog-form").dialog({autoOpen:!1,height:354,width:500,modal:!0,buttons:{"Add an expense":e.AddExpense,Cancel:function(){e.expenseItemDialog.dialog("close"),e.ExpenseDialogReset()}},close:function(){e.expenseItemDialog.dialog("close"),e.ExpenseDialogReset()}}),e.itmanagerWorkflowDialog=$("#it-dialog-form").dialog({autoOpen:!1,height:200,width:450,modal:!0,Open:function(){$(".cam-peoplepicker-delImage").click()},buttons:{Save:function(){return $(".cam-entity-resolved").text().length>0?(e.SaveFinanceManagerWorkflowDetails(),$("#finaceManagerWorkFlow").hide(),$(".cam-peoplepicker-delImage").click(),e.itmanagerWorkflowDialog.dialog("close"),void 0):!1},Cancel:function(){$(".cam-peoplepicker-delImage").click(),e.itmanagerWorkflowDialog.dialog("close")}},close:function(){e.itmanagerWorkflowDialog.dialog("close")}}),e.displayCommentsDialog=$("#comments-dialog-form").dialog({autoOpen:!1,height:250,width:540,modal:!0,Open:function(){$(".cam-peoplepicker-delImage").click()},buttons:{Cancel:function(){$(".cam-peoplepicker-delImage").click(),e.displayCommentsDialog.dialog("close")}},close:function(){e.displayCommentsDialog.dialog("close")}}),$("#add-expense").on("click",function(){e.expenseItemDialog.dialog("open")}),$("#reset").on("click",function(){return e.FormReset(),!1}),$("#submit-expense").click(function(){var t=e.CheckFormDataValidation(),a=$("#users tbody").children().length;return t?a>0?($("#div_error_report").hide(),e.SaveNewExpenseInfo(),e.GetAllExpenses(),e.FormReset(),!1):(alert("You do not have any expenses to be submitted!!!"),!1):($("#div_error_report").show(),!1)}),$("#Refresh-tickets").click(function(){e.myExpenses.length=0;var t=$("#tblMyExpenses").DataTable();return t.clear().draw(),e.GetAllExpenses(),!1}),$("#finaceManagerWorkFlow").click(function(){e.itmanagerWorkflowDialog.dialog("open")}),$("#tblMyExpenses").on("click","a",function(t){var a=$(this).attr("id"),n=e.GetExpenseByID(a);$("#mngr_comments").html(n.ManagerComments),$("#it_mngr_comments").html(n.FinanceManagerComments),e.displayCommentsDialog.dialog("open")}),Array.prototype.sum=function(e){for(var t=0,a=0,n=this.length;n>a;a++)t+=this[a][e];return t}});