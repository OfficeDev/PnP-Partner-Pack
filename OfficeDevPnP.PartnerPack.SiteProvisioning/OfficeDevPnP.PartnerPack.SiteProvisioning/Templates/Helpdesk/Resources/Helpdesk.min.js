$(document).ready(function(){"use strict";var t,e;t={editDialog:"",viewDialog:"",HELPDESK_LIST_NAME:"Helpdesk",HELPDESK_ITMANAGERWORKFLOW_LIST_NAME:"ITManagerWorkflow",EDIT_ATTACHMENT:"editattachment",SiteURL:window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl+"/",displayTicketsList:[],BindDropDownByIdListName:function(e,i){$.ajax({url:t.SiteURL+"_api/web/lists/getbytitle('"+i+"')/items",type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(t){var i=t.d.results;$.each(i,function(t){var a=i[t];$("#"+e).append($("<option></option>").val(a.ID).html(a.Title))})},error:function(t){console.log(t),console.log("Operataion failed")}})},GetItemTypeForListName:function(t){return"SP.Data."+t.charAt(0).toUpperCase()+t.split(" ").join("").slice(1)+"ListItem"},GenerateTicket:function(){var t=Math.floor(9e5*Math.random())+1e5;return t},CheckValidations:function(){var t=$("#subject").val().length,e=$("#ticket_description").val().length,i=$("#workstation").val().length;return 0===t||0===e||0===i?!1:!0},SaveNewTicketInfo:function(){var e=$("#subject").val(),i=$("#ticket_type").val(),a=$("#ticket_to").val(),o=$("#ticket_description").val(),r=$("#priority").val(),l=$("#workstation").val(),s=t.GenerateTicket(),c=t.GetItemTypeForListName(t.HELPDESK_LIST_NAME),n=_spPageContextInfo.userId,d=t.GetEmailFromText($("#hdnAdministrators").val().split(",")[2]),u="i:0#.f|membership|"+d,p={__metadata:{type:c},Title:e,Subject:e,Description:o,Workstation:l,TicketNumber:String(s),TicketTypeId:i,TicketToId:a,PriorityId:r,TicketFromId:n,ManagerId:t.EnsureUser(u)};$.ajax({url:t.SiteURL+"_api/web/lists/getbytitle('"+t.HELPDESK_LIST_NAME+"')/items",type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(p),async:!1,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(e){t.UploadFile(s,t.HELPDESK_LIST_NAME,t.SiteURL,"attachment");var i=[];i.push(p.TicketNumber),i.push(p.Subject),i.push("New"),i.push(p.TicketNumber),t.displayTicketsList.push(i),$("#spanStatus").html("Ticket created successfully").addClass("ticketsuccess"),$(".cam-peoplepicker-delImage").click(),console.log("Ticket created successfully")},error:function(t){$("#spanStatus").html("Ticket creation failed").addClass("ticketerror"),console.log("Ticket creation failed")}})},WriteFileToList:function(t,e,i,a){var o=new FileReader;o.onload=function(o){if(null!=t&&t.name.length>0){var r=e+"_api/web/lists/getByTitle(@TargetLibrary)/Items("+i+")/AttachmentFiles/add(FileName=@TargetFileName)?@TargetLibrary='"+a+"'&@TargetFileName='"+t.name+"'",l=o.target.result;$.ajax({url:r,async:!1,type:"POST",data:l,processData:!1,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(t){console.log("File uploaded successfully")},error:function(t){console.log("File upload failed. Please try again")}})}},o.readAsArrayBuffer(t)},UploadFile:function(e,i,a,o){var r=t.GetTicketByID(e),l=r.ID,s=$("#"+o)[0].files.length;if(s>0)for(var c=0;s>c;c++){var n=$("#"+o)[0].files[c];t.WriteFileToList(n,a,l,i)}},GetListItemWithId:function(t,e,i,a,o){var r=i+"/_api/web/lists/getbytitle('"+e+"')/items?$filter=Id eq "+t;$.ajax({url:r,method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(t){1===t.d.results.length?a(t.d.results[0]):o("Multiple results obtained for the specified Id value")},error:function(t){o(t)}})},UpdateListItemDetails:function(e,i,a,o,r){var l=t.CheckDialgValidations();if(l){$("#div_dialg_error").hide();var s=t.GetItemTypeForListName(i),c={__metadata:{type:s},Subject:$("#subject_dialg").val(),Description:$("#ticket_dialg_description").val(),Workstation:$("#workstation_dialg").val(),TicketTypeId:$("#ticket_dialg_type").val(),TicketToId:$("#ticket_dialg_to").val(),PriorityId:$("#priority_dialg").val(),TicketNumber:$("#dialg_ticketNumber").val()};t.GetListItemWithId(e,i,a,function(t){$.ajax({url:t.__metadata.uri,type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(c),headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val(),"X-HTTP-Method":"MERGE","If-Match":t.__metadata.etag},success:function(t){o(t,c)},error:function(t){r(t)}})},function(t){r(t)})}else $("#div_dialg_error").show()},UpdateListItem:function(){var e=window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl+"/";t.UpdateListItemDetails($("#dialg_ticketId").val(),t.HELPDESK_LIST_NAME,e,function(i,a){t.UploadFile($("#dialg_ticketNumber").val(),t.HELPDESK_LIST_NAME,e,t.EDIT_ATTACHMENT),$("#spanStatus").html("Ticket updated successfully").addClass("ticketsuccess"),console.log("Ticket updated successfully"),$.each(t.displayTicketsList,function(e,i){if(i[0]===a.TicketNumber){var o=t.displayTicketsList[e];o[1]=a.Subject,t.displayTicketsList[e]=o}}),t.DisplayMyTickets(t.displayTicketsList),t.editDialog.dialog("close")},function(){$("#"+t.EDIT_ATTACHMENT).val(""),$("#spanStatus").html("Ticket updation failed").addClass("ticketerror"),console.log("Ticket updation failed")})},RetrieveTickets:function(){e.init($("#tblMyTickets"),t.SiteURL),e.GetTicketsFromSPList()},DisplayMyTickets:function(e){var i=e;i.length>0?$("#Refresh-tickets").prop("disabled",!1):$("#Refresh-tickets").prop("disabled",!0),$("#tblMyTickets").DataTable({destroy:!0,lengthMenu:[5,10],data:i,columns:[{title:"Ticket#",render:function(t,e){return"display"===e?$("<a>").attr("href","#").attr("id",t).text(t).wrap("<div></div>").parent().html():t}},{title:"Title"},{title:"State"},{title:"",render:function(t,e){return"display"===e&&""!==t?$("<a>").attr("href","#").attr("id",t).text("Edit").wrap("<div></div>").parent().html():"Edit"}}]}),$("#tblMyTickets").on("click","a",function(e){var i=$(this).attr("id"),a=t.GetTicketByID(i),o=$(this).text();$("#spanStatus").html(""),"Edit"!==o?($("#view-ticket-type").html(a.TicketType.Title),$("#view-ticket-To").html(a.TicketTo.Title),$("#view-ticket-Subject").html(a.Subject),$("#view-ticket-Description").html(a.Description),$("#view-ticket-Priority").html(a.Priority.Title),$("#view-ticket-Workstation").html(a.Workstation),t.viewDialog.dialog("open")):($("#ticket_dialg_type").val(a.TicketTypeId),$("#ticket_dialg_to").val(a.TicketToId),$("#subject_dialg").val(a.Subject),$("#ticket_dialg_description").val(a.Description),$("#priority_dialg").val(a.PriorityId),$("#workstation_dialg").val(a.Workstation),$("#dialg_ticketNumber").val(a.TicketNumber),$("#dialg_ticketId").val(a.ID),null!==a&&a.Attachments===!0?$("#"+t.EDIT_ATTACHMENT).attr("disabled",!0):($("#"+t.EDIT_ATTACHMENT).attr("disabled",!1),$("#"+t.EDIT_ATTACHMENT).val("")),t.editDialog.dialog("open"))})},CheckDialgValidations:function(){var t=$("#subject_dialg").val().length,e=$("#ticket_dialg_description").val().length,i=$("#workstation_dialg").val().length;return 0===t||0===e||0===i?!1:!0},GetTicketByID:function(e){var i="",a=t.SiteURL+"_api/lists/getbytitle('"+t.HELPDESK_LIST_NAME+"')/items?$select=ID,TicketType/Title,TicketTo/Title,Subject,Description,PriorityId,TicketToId,TicketTypeId,Priority/Title,Workstation,TicketNumber,TicketStatus,Title,Attachments&$expand=TicketType,Priority,TicketTo&$filter=TicketNumber eq "+e;return $.ajax({url:a,async:!1,method:"GET",headers:{accept:"application/json;odata=verbose"},success:function(t){i=t.d.results[0]},error:function(t){console.log("Error occurred while retrieving the ticket")}}),i},FormReset:function(){return $("#subject").val(""),$("#ticket_description").val(""),$("#attachment").val(""),$("#workstation").val(""),$("#ticket_type").val("1"),$("#ticket_to").val("1"),$("#priority").val("1"),$(".cam-peoplepicker-delImage").click(),!1},EnsureUser:function(t){var e=0;return $.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/ensureUser('"+encodeURIComponent(t)+"')",type:"POST",async:!1,contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(t){t.d.Id>0&&(e=t.d.Id)},error:function(t){console.log(JSON.stringify(t))}}),e},GetEmailFromText:function(t){var e=t.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);return null!=e&&e.length>0?e[0]:""},GetITManagerWorkFlowDetails:function(){var e=t.SiteURL+"/_api/web/lists/getbytitle('"+t.HELPDESK_ITMANAGERWORKFLOW_LIST_NAME+"')/ItemCount";$.ajax({url:e,method:"GET",async:!1,headers:{Accept:"application/json; odata=verbose"},success:function(t){t.d.ItemCount>=1?($("#itManagerWorkFlow").hide(),$("#create-ticket").prop("disabled",!1)):($("#itManagerWorkFlow").show(),$("#create-ticket").prop("disabled",!0))},error:function(t){console.log("Error while retrieving information from ITManagerWorkflow")}})},SaveITManagerWorkflowDetails:function(){var e=t.GetItemTypeForListName(t.HELPDESK_ITMANAGERWORKFLOW_LIST_NAME),i=t.GetEmailFromText($("#hdnAdministrators1").val().split(",")[2]),a="i:0#.f|membership|"+i,o={__metadata:{type:e},ITManagerId:t.EnsureUser(a)};$.ajax({url:t.SiteURL+"_api/web/lists/getbytitle('"+t.HELPDESK_ITMANAGERWORKFLOW_LIST_NAME+"')/items",type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(o),headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(t){$("#spanStatus").html("IT Manager Workflow record created successfully").addClass("ticketsuccess"),$("#create-ticket").prop("disabled",!1),console.log("IT Manager Workflow record created successfully")},error:function(t){$("#spanStatus").html("IT Manager Workflow record creation failed").addClass("ticketerror"),console.log("IT Manager Workflow record creation failed")}})}},t.GetITManagerWorkFlowDetails(),e={element:"",url:"",init:function(i,a){e.element=i,e.url=a+"_api/lists/getbytitle('"+t.HELPDESK_LIST_NAME+"')/items?$select=TicketNumber,Subject,TicketStatus&$filter=AuthorId eq "+_spPageContextInfo.userId},GetTicketsFromSPList:function(){$.ajax({url:e.url,method:"GET",headers:{accept:"application/json;odata=verbose"},success:e.onSuccess,error:e.onError})},onSuccess:function(e){var i=e.d.results;$.each(i,function(e){var a=i[e],o=[];o.push(a.TicketNumber),o.push(a.Subject),o.push(a.TicketStatus),"New"===a.TicketStatus?o.push(a.TicketNumber):o.push(""),t.displayTicketsList.push(o)}),t.DisplayMyTickets(t.displayTicketsList)},onError:function(t){$("#tblMyTickets tbody").html("<h3>An error occured</h3><br/>"+JSON.stringify(t))}},t.BindDropDownByIdListName("ticket_type","TicketType"),t.BindDropDownByIdListName("ticket_to","TicketTo"),t.BindDropDownByIdListName("priority","Priority"),t.BindDropDownByIdListName("ticket_dialg_type","TicketType"),t.BindDropDownByIdListName("ticket_dialg_to","TicketTo"),t.BindDropDownByIdListName("priority_dialg","Priority"),$("#create-ticket").click(function(){var e=t.CheckValidations();return e&&$(".cam-entity-resolved").text().length>0?($("#div_error").hide(),t.SaveNewTicketInfo(),t.DisplayMyTickets(t.displayTicketsList),t.FormReset(),!1):($("#div_error").show(),!1)}),t.RetrieveTickets(),$("#reset-ticket").click(function(){return t.FormReset(),$("#spanStatus").html(""),!1}),t.editDialog=$("#dialog-form").dialog({autoOpen:!1,height:600,width:425,modal:!0,buttons:{Save:t.UpdateListItem,Cancel:function(){t.editDialog.dialog("close")}},close:function(){t.editDialog.dialog("close")}}),t.viewDialog=$("#dialog-view").dialog({autoOpen:!1,height:400,width:425,modal:!0,buttons:{Close:function(){t.viewDialog.dialog("close")}},close:function(){t.viewDialog.dialog("close")}}),t.itmanagerWorkflowDialog=$("#it-dialog-form").dialog({autoOpen:!1,height:200,width:450,modal:!0,Open:function(){$(".cam-peoplepicker-delImage").click()},buttons:{Save:function(){return $(".cam-entity-resolved").text().length>0?(t.SaveITManagerWorkflowDetails(),$("#itManagerWorkFlow").hide(),$(".cam-peoplepicker-delImage").click(),t.itmanagerWorkflowDialog.dialog("close"),void 0):!1},Cancel:function(){$(".cam-peoplepicker-delImage").click(),t.itmanagerWorkflowDialog.dialog("close")}},close:function(){t.itmanagerWorkflowDialog.dialog("close")}}),$("#itManagerWorkFlow").click(function(){t.itmanagerWorkflowDialog.dialog("open")}),$("#Refresh-tickets").click(function(){t.displayTicketsList.length=0;var e=$("#tblMyTickets").DataTable();return e.clear().draw(),t.RetrieveTickets(),!1}),$("#div_error").hide(),$("#div_dialg_error").hide()});