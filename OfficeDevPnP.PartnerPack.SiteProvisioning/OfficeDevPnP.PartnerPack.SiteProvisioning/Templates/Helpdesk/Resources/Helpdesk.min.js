$(document).ready(function(){"use strict";var t,e;t={editDialog:"",viewDialog:"",HELPDESK_LIST_NAME:"Helpdesk",EDIT_ATTACHMENT:"editattachment",SiteURL:window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl+"/",displayTicketsList:[],BindDropDownByIdListName:function(e,i){$.ajax({url:t.SiteURL+"_api/web/lists/getbytitle('"+i+"')/items",type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(t){var i=t.d.results;$.each(i,function(t){var a=i[t];$("#"+e).append($("<option></option>").val(a.ID).html(a.Title))})},error:function(t){console.log(t),console.log("Operataion failed")}})},GetItemTypeForListName:function(t){return"SP.Data."+t.charAt(0).toUpperCase()+t.split(" ").join("").slice(1)+"ListItem"},GenerateTicket:function(){var t=Math.floor(9e5*Math.random())+1e5;return t},CheckValidations:function(){var t=$("#subject").val().length,e=$("#ticket_description").val().length,i=$("#workstation").val().length;return 0===t||0===e||0===i?!1:!0},SaveNewTicketInfo:function(){var e=$("#subject").val(),i=$("#ticket_type").val(),a=$("#ticket_to").val(),o=$("#ticket_description").val(),r=$("#priority").val(),l=$("#workstation").val(),c=t.GenerateTicket(),s=t.GetItemTypeForListName(t.HELPDESK_LIST_NAME),n=_spPageContextInfo.userId,d={__metadata:{type:s},Title:e,Subject:e,Description:o,Workstation:l,TicketNumber:String(c),TicketTypeId:i,TicketToId:a,PriorityId:r,StatusId:1,TicketFromId:n};$.ajax({url:t.SiteURL+"_api/web/lists/getbytitle('"+t.HELPDESK_LIST_NAME+"')/items",type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(d),async:!1,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(e){t.UploadFile(c,t.HELPDESK_LIST_NAME,t.SiteURL,"attachment");var i=[];i.push(d.TicketNumber),i.push(d.Subject),i.push("New"),i.push(d.TicketNumber),t.displayTicketsList.push(i),console.log("Item is added successfully")},error:function(t){console.log("Operataion failed")}})},UploadFile:function(e,i,a,o){var r=t.GetTicketByID(e),l=r.ID,c=$("#"+o)[0].files[0];if(null!=c&&c.name.length>0){var s=a+"_api/web/lists/getByTitle(@TargetLibrary)/Items("+l+")/AttachmentFiles/add(FileName=@TargetFileName)?@TargetLibrary='"+i+"'&@TargetFileName='"+c.name+"'",n="This is the content of the file added through REST API";$.ajax({url:s,async:!1,type:"POST",contentType:"application/json;odata=verbose",data:n,headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(t){console.log("File uploaded successfully")},error:function(t){console.log("File upload failed. Please try again")}})}},GetListItemWithId:function(t,e,i,a,o){var r=i+"/_api/web/lists/getbytitle('"+e+"')/items?$filter=Id eq "+t;$.ajax({url:r,method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(t){1===t.d.results.length?a(t.d.results[0]):o("Multiple results obtained for the specified Id value")},error:function(t){o(t)}})},UpdateListItemDetails:function(e,i,a,o,r){var l=t.CheckDialgValidations();if(l){$("#div_dialg_error").hide();var c=t.GetItemTypeForListName(i),s={__metadata:{type:c},Subject:$("#subject_dialg").val(),Description:$("#ticket_dialg_description").val(),Workstation:$("#workstation_dialg").val(),TicketTypeId:$("#ticket_dialg_type").val(),TicketToId:$("#ticket_dialg_to").val(),PriorityId:$("#priority_dialg").val(),TicketNumber:$("#dialg_ticketNumber").val()};t.GetListItemWithId(e,i,a,function(t){$.ajax({url:t.__metadata.uri,type:"POST",contentType:"application/json;odata=verbose",data:JSON.stringify(s),headers:{Accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val(),"X-HTTP-Method":"MERGE","If-Match":t.__metadata.etag},success:function(t){o(t,s)},error:function(t){r(t)}})},function(t){r(t)})}else $("#div_dialg_error").show()},UpdateListItem:function(){var e=window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl+"/";t.UpdateListItemDetails($("#dialg_ticketId").val(),t.HELPDESK_LIST_NAME,e,function(i,a){t.UploadFile($("#dialg_ticketNumber").val(),t.HELPDESK_LIST_NAME,e,t.EDIT_ATTACHMENT),console.log("Item updated, refreshing avilable items"),$.each(t.displayTicketsList,function(e,i){if(i[0]===a.TicketNumber){var o=t.displayTicketsList[e];o[1]=a.Subject,t.displayTicketsList[e]=o}}),t.DisplayMyTickets(t.displayTicketsList),t.editDialog.dialog("close")},function(){$("#"+t.EDIT_ATTACHMENT).val(""),console.log("Oops, an error occured. Please try again")})},RetrieveTickets:function(){e.init($("#tblMyTickets"),t.SiteURL),e.GetTicketsFromSPList()},DisplayMyTickets:function(e){var i=e;$("#tblMyTickets").DataTable({destroy:!0,lengthMenu:[5,10],data:i,columns:[{title:"Ticket#",render:function(t,e){return"display"===e?$("<a>").attr("href","#").attr("id",t).text(t).wrap("<div></div>").parent().html():t}},{title:"Title"},{title:"State"},{title:"",render:function(t,e){return"display"===e?$("<a>").attr("href","#").attr("id",t).text("Edit").wrap("<div></div>").parent().html():t}}]}),$("#tblMyTickets").on("click","a",function(e){var i=$(this).attr("id"),a=t.GetTicketByID(i),o=$(this).text();"Edit"!==o?($("#view-ticket-type").html(a.TicketType.Title),$("#view-ticket-To").html(a.TicketTo.Title),$("#view-ticket-Subject").html(a.Subject),$("#view-ticket-Description").html(a.Description),$("#view-ticket-Priority").html(a.Priority.Title),$("#view-ticket-Workstation").html(a.Workstation),t.viewDialog.dialog("open")):($("#ticket_dialg_type").val(a.TicketTypeId),$("#ticket_dialg_to").val(a.TicketToId),$("#subject_dialg").val(a.Subject),$("#ticket_dialg_description").val(a.Description),$("#priority_dialg").val(a.PriorityId),$("#workstation_dialg").val(a.Workstation),$("#dialg_ticketNumber").val(a.TicketNumber),$("#dialg_ticketId").val(a.ID),null!==a&&a.Attachments===!0?$("#"+t.EDIT_ATTACHMENT).attr("disabled",!0):($("#"+t.EDIT_ATTACHMENT).attr("disabled",!1),$("#"+t.EDIT_ATTACHMENT).val("")),t.editDialog.dialog("open"))})},CheckDialgValidations:function(){var t=$("#subject_dialg").val().length,e=$("#ticket_dialg_description").val().length,i=$("#workstation_dialg").val().length;return 0===t||0===e||0===i?!1:!0},GetTicketByID:function(e){var i="",a=t.SiteURL+"_api/lists/getbytitle('"+t.HELPDESK_LIST_NAME+"')/items?$select=ID,TicketType/Title,TicketTo/Title,Subject,Description,PriorityId,TicketToId,TicketTypeId,Priority/Title,Workstation,TicketNumber,StatusId,Title,Attachments&$expand=TicketType,Priority,TicketTo&$filter=TicketNumber eq "+e;return $.ajax({url:a,async:!1,method:"GET",headers:{accept:"application/json;odata=verbose"},success:function(t){i=t.d.results[0]},error:function(t){console.log("Error occurred while retrieving the ticket")}}),i},FormReset:function(){return $("#subject").val(""),$("#ticket_description").val(""),$("#attachment").val(""),$("#workstation").val(""),$("#ticket_type").val("1"),$("#ticket_to").val("1"),$("#priority").val("1"),!1}},e={element:"",url:"",init:function(i,a){e.element=i,e.url=a+"_api/lists/getbytitle('"+t.HELPDESK_LIST_NAME+"')/items?$select=TicketNumber,Subject,Status/Title&$expand=Status"},GetTicketsFromSPList:function(){$.ajax({url:e.url,method:"GET",headers:{accept:"application/json;odata=verbose"},success:e.onSuccess,error:e.onError})},onSuccess:function(e){var i=e.d.results;$.each(i,function(e){var a=i[e],o=[];o.push(a.TicketNumber),o.push(a.Subject),o.push(a.Status.Title),o.push(a.TicketNumber),t.displayTicketsList.push(o)}),t.DisplayMyTickets(t.displayTicketsList)},onError:function(t){$("#tblMyTickets tbody").html("<h3>An error occured</h3><br/>"+JSON.stringify(t))}},t.BindDropDownByIdListName("ticket_type","TicketType"),t.BindDropDownByIdListName("ticket_to","TicketTo"),t.BindDropDownByIdListName("priority","Priority"),t.BindDropDownByIdListName("ticket_dialg_type","TicketType"),t.BindDropDownByIdListName("ticket_dialg_to","TicketTo"),t.BindDropDownByIdListName("priority_dialg","Priority"),$("#create-ticket").click(function(){var e=t.CheckValidations();return e?($("#div_error").hide(),t.SaveNewTicketInfo(),t.DisplayMyTickets(t.displayTicketsList),t.FormReset(),!1):($("#div_error").show(),!1)}),t.RetrieveTickets(),$("#reset-ticket").click(function(){return t.FormReset(),!1}),t.editDialog=$("#dialog-form").dialog({autoOpen:!1,height:600,width:425,modal:!0,buttons:{Save:t.UpdateListItem,Cancel:function(){t.editDialog.dialog("close")}},close:function(){t.editDialog.dialog("close")}}),t.viewDialog=$("#dialog-view").dialog({autoOpen:!1,height:400,width:425,modal:!0,buttons:{Close:function(){t.viewDialog.dialog("close")}},close:function(){t.viewDialog.dialog("close")}}),$("#div_error").hide(),$("#div_dialg_error").hide()});